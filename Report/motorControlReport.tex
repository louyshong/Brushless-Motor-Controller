\documentclass{article}

%~~~~~~~~~ Document setup
\usepackage[english]{babel} % English formatting
\usepackage[utf8]{inputenc} % Standard encoding
\usepackage[a4paper,left=3cm,bottom=3cm]{geometry} % Page formatting
\usepackage{indentfirst} % Indents the first paragraph
\usepackage{amsmath} % Maths type package
\usepackage{bm} % Bold font maths
\usepackage{graphicx} % Advanced graphics package
\usepackage[export]{adjustbox} 
\usepackage{pdflscape} % Make pages landscape
\usepackage{fancyhdr} % Fancy headers
\usepackage[colorlinks=true,citecolor=blue,urlcolor=blue,linkcolor=black]{hyperref} % Link colours
\usepackage{natbib} % Bibliography
\usepackage{flafter} % Reference any 'float'
\usepackage[framemethod=tikz]{mdframed} % Box off stuff
\usepackage{color} % Colour support
\usepackage{wrapfig} % Text flowing around figures
\usepackage{lipsum} % Generates meaningless text
\usepackage{listings}
\usepackage{xcolor}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
 
\lstset{style=mystyle}
\graphicspath{ {Images/} } % Folder for images 

%~~~~~~~~~ Multi-column setup
\usepackage{multicol} % Multi Column Environment
\setlength{\columnsep}{1cm}
\setlength{\columnseprule}{1pt}
\def\columnseprulecolor{\color{black}} % comment this to remove the line
\usepackage{float} % Lets you add images to multi-column environment

%~~~~~~~~~ Page setup
\pagestyle{fancy}
\fancyhf{}
\lhead{Sajid-Lulwa-Tuck}
\lfoot{Brushless Motor Controller}
\rhead{March 2020}
\rfoot{Page \thepage}
\renewcommand{\footrulewidth}{0.4pt}

%~~~~~~~~~ Title
\title{Brushless Motor Controller}
\author{Sajid Lulwa Louys}
\date{\today}

%~~~~~~~~~ Document start
\begin{document}

\begin{titlepage}
    \begin{center}
        \vspace*{1cm}
            
        \Huge
        \textbf{Embedded Systems}
            
        \vspace{0.5cm}
        \LARGE
        \textbf{Brushless Motor Controller}
            
        \vspace{1.5cm}
            
        \textbf{Team Name: Friends}\\ 
            
        \vfill
            
        Coursework 2 Report\\
       
            
        \vspace{0.8cm}
         
            
        \Large
        \textbf{Team Members:}\\
        Sajid Ali\\
        Tuck Hong 01336059\\
        Lulwa Alkhalifa \\
            
    \end{center}
\end{titlepage}


\pagenumbering{gobble} % keep title page without a number
%\maketitle
\tableofcontents
\thispagestyle{empty} % remove page numbering for contents page
\clearpage

\pagenumbering{arabic} % start page numbers again
\setcounter{page}{1}

\section{Introduction}
\subsection{Brief}
In this report is summarised the implementation of a brushless motor controller which performs additional lower priority tasks in an embedded system.

\subsection{Specification}
\noindent The system was designed to meet the following design criteria:
 \begin{itemize}
	\item Motor will spin for defined number of rotations and stop without overshooting with a precision of \underline{0.5 rotations per number of rotations}.
	\item Motor will spin at a defined maximum angular velocity \underline{5-100 rotations per second}, with a precision of \underline{0.5 rotations per second}.
	\item Perform Bitcoin mining task and test \underline{5000 nonces per second}. Matching nonces will be sent back to the host.
	\item Motor will play a melody while it is spinning. The melody is a repeating sequence of notes in C4 octave with durations of \underline{0.125-1 seconds}.
\end{itemize}

\paragraph{This is a paragraph}
\lipsum[2]

\subparagraph{And this is a subparagraph}
\lipsum[3]




\section{Motor Control Implementation}
\subsection{Position and Velocity Measurements}

\subsection{Velocity Control}

\subsection{Position Control}



\section{Tasks and Dependencies}
\subsection{Motor Control}

\subsection{Melody}

By modulating the PWM period and hence the drive current, the motor effectively behaves like a tune generator. A separate thread \textbf{TuneThread} is responsible for changing the PWM period based on the notes present in melody commands given by the user. The notes that are allowed belong to the C4 octave, in other words, frequencies 261.63 Hz (C4) up to 493.88 Hz (B4).   

\bigskip

First, a map containing all the allowed notes and their corresponding PWM periods is initialised. Note that the PWM periods (in $\mu$s) are calculated using $\frac{1000000}{frequency}$. 

\bigskip

\lstinputlisting[language=C++]{melody1.cpp}

\bigskip

In an infinite loop, the thread repeats the following steps where \textbf{tonesQ} is a queue containing the notes and durations that need to be played. 

\bigskip

\lstinputlisting[language=C++]{melody2.cpp}

\bigskip

Since \textbf{tonesQ} is a shared data structure also accessed by \textbf{TerminalListenerThread}, the popping and pushing actions are protected with a mutex. Note that after popping a tone from \textbf{tonesQ} the same tone is immediately pushed back, as the specification requires the motor to play a given melody on loop. 

\bigskip

Following the regex for melody commands where the last entry in the command is an integer corresponding to the duration of the note (number of eighths of a second), the exact duration in milliseconds is obtained in line 8. Note that \textbf{(int)'0'} represents the offset value for numerical ASCII characters such that when subtracted from \textbf{(int)duration}, duration (which is a \textbf{char}) is effectively ``converted" into an \textbf{int}. 

\bigskip

After setting the new PWM period using \textbf{tone} and \textbf{tonefreqmap} initialised previously, the thread is then put to sleep using \textbf{ThisThread::sleep\_for(interval)} so that a given note will last for the specified amount of time before the loop continues with the next note to be played. This solves the issue of blocking other threads from running (e.g. the bitcoin thread which will result in the thread failing to meet 5000 nonces per second) when \textbf{wait} is used instead.   

\bigskip

This task is dependent on a non-empty \textbf{tonesQ}. This dependency is released by \textbf{TerminalListenerThread} when a melody command is received from the user. 

\subsection{Decoding Messages}

\subsection{Outputting Messages}

\subsection{Bitcoin Mining}

The bitcoin mining task is implemented in \textbf{BitcoinThread} as a low priority thread. The task is to look for matching nonces such that when combined with a key provided by the user and the 48 bytes of constant payload, will produce a SHA-256 hash that begins with 16 zeros. This is done by simply initialising the nonce to 0 and incrementing by one on each attempt. 

\bigskip

In order to regulate the mining task so that it satisfies the throughput specification of exactly 5000 nonces per second, the \textbf{Ticker} class is used to set up a timer interrupt that sends a signal to \textbf{BitcoinThread} every second. Every time the thread is released by the signal (which happens once per second), 5000 nonces are tested. The specification also requires the thread to send matching nonces back to the host. This is done by putting a \textbf{Mail} message pointer of type \textbf{BITCOIN\_NONCE} in the \textbf{mail\_box} queue. 

\bigskip

\lstinputlisting[language=C++]{bitcoin1.cpp}

\bigskip

A dependency this task has is the semaphore-like signal from the timer interrupt. This dependency is released once per second (by the timer interrupt). Note that a mutex is used here as \textbf{newKey} is a shared variable that is also accessed by \textbf{TerminalListenerThread} when a new bitcoin key is set by the user. 


\subsection{Dependency Graph}



\section{Timings and CPU Utilisation}
\subsection{Methodology}
To ensure the system would meet the design criteria outlined in the introduction it was crucial that we measure and simulate the worst case performance. 

\subsection{Measure Results}
\begin{table}[ht]
\centering                      % used for centering table
\begin{tabular}{c c c c}        % centered columns (4 columns)
Task & Initiation Interval (t) & Execution Time (T) & CPU Utilization (U) \\ [0.5ex]   % inserts table %heading
\hline                          % inserts 1 horizontal line
ISR & 0 & 0 & 0 \\           % table contents
Output & 0 & 0 & 0 \\                         
Motor Control & 0 & 0  & 0 \\
Decode & 0 & 0 & 0 \\
BitCoin Mining & 1s & 0 & 0 \\
Melody & 0.125s & 0 & 0\\[1ex]     % [1ex] adds vertical space
\end{tabular}
\caption{Task timing and resource utilization.} 
\label{table:nonlin}            % is used to refer this table in the text
\end{table}


\subsection{Critical Instant Analysis of the Rate Monotonic Scheduler}









\section{Highlighting and footnotes}
You can make words \textbf{bold}, \textit{italicise} them, \underline{underline words} or \textbf{make them \emph{stand out} regardless of the surrounding}. You can break a line\\ mid sentence and make footnotes like this \footnote{a footnote}.

\section{Equations}

% Forgot a symbol? See the LaTeX symbol wiki https://en.wikipedia.org/wiki/Wikipedia:LaTeX_symbols

\subsection{As part of text}

In total 85 distinct galaxies were identified in the Hubble Deep Field image provided, the list of which can be found in Appendix B at the end of this report. Poisson statistics states that the error in the number of galaxies counted ($N_x$) is simply the root of the count ($\sqrt{N_x}$), this can be represented as a percentage by the following equation, $N_x^2 + N^2$.

\subsection{In the middle, not numbered} 

$$ \alpha \beta \times \frac{2G}{x^2B_n}$$

$$ \frac{-b \pm \sqrt{b^2-4ac}}{2a} + \sin{x}$$

% mag = 5 * np.log10(dlpc/10) + M
$$ \mathrm{mag} = 5 \times \mathrm{log}_{10}\left(\frac{D_{l}}{10}\right) + \mathrm{M_{corr}}$$

\subsubsection{And in the middle, numbered}
\begin{equation}
    A=bx+24\times F_x
    \label{eq:lovely formula}
\end{equation}

\section{Adding images}
Hello, here is some text without a meaning.  This text should show what a printed text will look like at this place. If you read this text, you will get no information.  Really?  Is there no information?  Is there.

%\subsection{Lonely image}
%\begin{figure}[h!]
%    \centering % keeps the image in the centre
%    \includegraphics[width=0.5\textwidth]{snailfrog.png}
%    \caption{A visualisation of a frog.}
%    \label{fig:frog}
%\end{figure}

\lipsum[7]

\subsubsection{Images side by side}
%\begin{figure}[h]
%    \centering
%    \begin{minipage}{0.45\textwidth}
%        \centering
%        \includegraphics[width=0.9\textwidth]{frog.jpg}
%        \caption{first figure}
%    \end{minipage}\hfill
%    \begin{minipage}{0.45\textwidth}
%        \centering
%        \includegraphics[width=0.9\textwidth]{serious_frog.jpeg}
%        \caption{second figure}
%    \end{minipage}
%\end{figure}

\section{Citing and referencing}

\subsection{Referencing figures and equations}
 Expression $4\times 3=G\times x$ naturally follows from Eq \ref{eq:lovely formula}, and both of these things have a lot to do with Fig \ref{fig:frog in multicol}.
 
 \subsection{Citing a paper}
This statement has a citation at the end of it \cite{toadetal1958}, and this one has two \cite{toadetal1958, squeaker1982}. A citation with parenthesis is sure to follow \citep{siddiqi2004interspecific}.

 


%~~~~~~~~~ Bibliography
\bibliographystyle{abbrvnat}
\setcitestyle{authoryear}
\bibliography{bib}

\end{document}